@page
@model EditorModel
@{
    ViewData["Title"] = "LaTeX Editor";
}

@section Styles {
    <style>
        /* Custom header with dark background */
        .editor-header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            margin-left: -15px;
            margin-right: -15px;
            margin-top: -16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Override container for full width */
        .editor-container-fluid {
            width: 100%;
            padding-right: 0;
            padding-left: 0;
            margin-right: 0;
            margin-left: 0;
        }

        /* Make editor take more space */
        #latex-editor {
            width: 100%;
            min-height: 300px;
            height: 100%;
            resize: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-radius: 0;
        }

        /* Set fixed heights for content areas */
        .content-area {
            height: calc(100vh - 350px);
            min-height: 300px;
            overflow: auto;
        }

        /* Section headers */
        .section-header {
            background-color: #f8f9fa;
            padding: 0.5rem;
            font-weight: bold;
            border-bottom: 1px solid #dee2e6;
        }

        /* Error items */
        .error-high {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .error-medium {
            border-left: 4px solid #ffc107;
            background-color: #fff3cd;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Status bar */
        .status-bar {
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-top: 1px solid #dee2e6;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
    </style>
}

<!-- Editor Header - Full Width -->
<div class="editor-header">
    <h1>LaTeX Editor</h1>
    <div>
        <button id="download-pdf-btn" class="btn btn-primary">Download PDF</button>
    </div>
</div>

<!-- Toolbar -->
<div class="bg-light d-flex align-items-center p-2 border-bottom mb-2">
    <button id="compile-btn" class="btn btn-primary me-2">Compile</button>
    <button id="save-btn" class="btn btn-primary me-2">Save</button>
    <select id="bibliography-style" class="form-select me-2" style="width: auto;">
        <option value="apa">APA</option>
        <option value="mla">MLA</option>
    </select>
    <label for="bibliography-style">Bibliography Style</label>
</div>

<!-- Editor and Preview -->
<div class="row mx-0">
    <!-- LaTeX Editor Section -->
    <div class="col-md-6 px-0 border-end">
        <div class="section-header">LaTeX Editor</div>
        <div class="content-area">
            <textarea id="latex-editor" class="form-control border-0 p-2">\documentclass{article}
\title{Sample Document}
\author{User}
\date{\today}

\begin{document}
\maketitle

\section{Introduction}
This is a sample LaTeX document.

\end{document}</textarea>
        </div>
    </div>
    
    <!-- Preview Section -->
    <div class="col-md-6 px-0">
        <div class="section-header">PDF Preview</div>
        <div class="content-area p-2" id="pdf-preview">
            <p class="text-secondary">PDF preview will appear here after compilation.</p>
            <img src="/api/placeholder/600/800" alt="PDF preview placeholder" class="img-fluid" />
        </div>
    </div>
</div>

<!-- Error Panel -->
<div class="mt-3">
    <div class="section-header">Errors and Warnings</div>
    <div id="error-list" class="p-2" style="max-height: 150px; overflow-y: auto;">
        <div class="error-high">
            <strong>Line 10:</strong> Missing closing bracket for \begin{document} command
        </div>
        <div class="error-medium">
            <strong>Line 15:</strong> Undefined reference to 'fig:sample'
        </div>
    </div>
</div>

<!-- Status Bar -->
<div class="status-bar mt-2">
    <div id="compilation-status">Ready</div>
    <div id="document-info">Lines: 10 | Words: 50</div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const compileBtn = document.getElementById('compile-btn');
            const latexEditor = document.getElementById('latex-editor');
            const pdfPreview = document.getElementById('pdf-preview');
            const compilationStatus = document.getElementById('compilation-status');

            // ✅ Load LaTeX content into editor when the page loads
            fetch('/home/load-latex')
                .then(response => response.text())
                .then(data => {
                    if (data.trim() !== '') {
                        latexEditor.value = data;
                    }
                })
                .catch(error => console.error('Error loading LaTeX:', error));

            // ✅ Compile LaTeX to PDF when the "Compile" button is clicked
            compileBtn.addEventListener('click', function() {
                compilationStatus.textContent = 'Compiling...';

                fetch('/home/compile-latex', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ latexContent: latexEditor.value }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        compilationStatus.textContent = 'Compilation successful!';
                        pdfPreview.innerHTML = `<iframe src="${data.pdfUrl}#${new Date().getTime()}" width="100%" height="500px" style="border: none;"></iframe>`;
                    } else {
                        compilationStatus.textContent = 'Compilation failed!';
                        console.error('Compilation error:', data.error);
                    }
                })
                .catch(error => {
                    compilationStatus.textContent = 'Compilation failed!';
                    console.error('Error:', error);
                });
            });
        });
    </script>
}
