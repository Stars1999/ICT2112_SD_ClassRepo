@page
@model EditorModel
@{
    ViewData["Title"] = "LaTeX Editor";
}

@section Styles {
    <style>
        /* Custom header with dark background */
        .editor-header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            margin-left: -15px;
            margin-right: -15px;
            margin-top: -16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Override container for full width */
        .editor-container-fluid {
            width: 100%;
            padding-right: 0;
            padding-left: 0;
            margin-right: 0;
            margin-left: 0;
        }

        /* Make editor take more space */
        #latex-editor {
            width: 100%;
            min-height: 300px;
            height: 100%;
            resize: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-radius: 0;
        }

        /* Set fixed heights for content areas */
        .content-area {
            height: calc(100vh - 350px);
            min-height: 300px;
            overflow: auto;
        }

        /* Section headers */
        .section-header {
            background-color: #f8f9fa;
            padding: 0.5rem;
            font-weight: bold;
            border-bottom: 1px solid #dee2e6;
        }

        /* Error items */
        .error-high {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .error-medium {
            border-left: 4px solid #ffc107;
            background-color: #fff3cd;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Status bar */
        .status-bar {
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-top: 1px solid #dee2e6;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
    </style>
}

<!-- Editor Header - Full Width -->
<div class="editor-header">
    <h1>LaTeX Editor</h1>
    <div>
        <button id="download-pdf-btn" class="btn btn-primary">Download PDF</button>
    </div>
</div>

<!-- Toolbar -->
<div class="bg-light d-flex align-items-center p-2 border-bottom mb-2">
    <button id="compile-btn" class="btn btn-primary me-2">Compile</button>
    <button id="save-btn" class="btn btn-primary me-2">Save</button>
    <select id="bibliography-style" class="form-select me-2" style="width: auto;">
        <option value="apa">APA</option>
        <option value="mla">MLA</option>
    </select>
    <label for="bibliography-style">Bibliography Style</label>
</div>

<!-- Editor and Preview -->
<div class="row mx-0">
    <!-- LaTeX Editor Section -->
    <div class="col-md-6 px-0 border-end">
        <div class="section-header">LaTeX Editor</div>
        <div class="content-area">
            <textarea id="latex-editor" class="form-control border-0 p-2">\documentclass{article}
\title{Sample Document}
\author{User}
\date{\today}

\begin{document}
\maketitle

\section{Introduction}
This is a sample LaTeX document.

\end{document}</textarea>
        </div>
    </div>
    
    <!-- Preview Section -->
    <div class="col-md-6 px-0">
        <div class="section-header">PDF Preview</div>
        <div class="content-area p-2" id="pdf-preview">
            <p class="text-secondary">PDF preview will appear here after compilation.</p>
            <img src="/api/placeholder/600/800" alt="PDF preview placeholder" class="img-fluid" />
        </div>
    </div>
</div>

<!-- Error Panel -->
<div class="mt-3">
    <div class="section-header">Errors and Warnings</div>
    <div id="error-list" class="p-2" style="max-height: 150px; overflow-y: auto;">
        <div class="error-high">
            <strong>Line 10:</strong> Missing closing bracket for \begin{document} command
        </div>
        <div class="error-medium">
            <strong>Line 15:</strong> Undefined reference to 'fig:sample'
        </div>
    </div>
</div>

<!-- Status Bar -->
<div class="status-bar mt-2">
    <div id="compilation-status">Ready</div>
    <div id="document-info">Lines: 10 | Words: 50</div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const compileBtn = document.getElementById('compile-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const latexEditor = document.getElementById('latex-editor');
            const pdfPreview = document.getElementById('pdf-preview');
            const compilationStatus = document.getElementById('compilation-status');
            const bibliographyDropdown = document.getElementById('bibliography-style');
            const errorList = document.getElementById('error-list');

            // ✅ Load citation style from a session cookie (default to APA)
            function getCookie(name) {
                let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                return match ? decodeURIComponent(match[2]) : 'apa'; // Default to APA
            }

            function setCookie(name, value, days) {
                let expires = "";
                if (days) {
                    let date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/";
            }

            let savedStyle = getCookie("selectedCitationStyle");
            bibliographyDropdown.value = savedStyle; // Ensure correct option is selected

            console.log(`[INFO] Loaded citation style: ${savedStyle}`);

            // ✅ Load LaTeX content into editor AFTER applying the selected style
            fetch(`/home/load-latex?style=${savedStyle}`)
                .then(response => response.text())
                .then(data => {
                    if (data.trim() !== '') {
                        latexEditor.value = data;
                    }
                })
                .catch(error => console.error('Error loading LaTeX:', error));

            // ✅ Handle citation style change and persist selection in cookies
            bibliographyDropdown.addEventListener('change', function() {
                const selectedStyle = bibliographyDropdown.value;
                setCookie("selectedCitationStyle", selectedStyle, 30); // Save selection for 30 days

                console.log(`[DEBUG] User selected: ${selectedStyle}`);

                fetch(`/home/convert?style=${selectedStyle}`, { method: 'GET' })
                .then(response => {
                    console.log(`[INFO] Style updated to ${selectedStyle}, reloading editor.`);
                    window.location.href = '/home/editor'; // ✅ Reload editor with new citation style
                })
                .catch(error => console.error('Error changing citation style:', error));
            });

            // ✅ Function to Fetch and Display Errors
            function fetchErrors() {
                fetch("/home/errors")
                .then(response => response.json())
                .then(data => {
                    errorList.innerHTML = ""; // ✅ Clear existing errors

                    if (data.errors.length === 0) {
                        errorList.innerHTML = "<p class='text-secondary'>No errors yet.</p>";
                        return;
                    }

                    data.errors.forEach(error => {
                        let errorDiv = document.createElement("div");
                        errorDiv.className = "error-high"; // Highlight errors
                        errorDiv.innerHTML = `<strong>Error:</strong> ${error}`;
                        errorList.appendChild(errorDiv);
                    });
                })
                .catch(error => console.error("Error fetching errors:", error));
            }

            // ✅ Compile LaTeX to PDF when the "Compile" button is clicked
            compileBtn.addEventListener('click', function() {
                let latexContent = latexEditor.value.trim();

                // ✅ Prevent sending empty LaTeX content
                if (!latexContent || !latexContent.includes("\\begin{document}")) {
                    compilationStatus.textContent = "Error: LaTeX content is empty or invalid.";
                    console.error("Error: LaTeX content is empty or missing \\begin{document}");
                    return;
                }

                compilationStatus.textContent = "Compiling...";

                fetch("/home/compile-latex", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ latexContent }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        compilationStatus.textContent = "Compilation successful!";
                        pdfPreview.innerHTML = `<iframe src="${data.pdfUrl}#${new Date().getTime()}" width="100%" height="500px" style="border: none;"></iframe>`;
                        
                        // ✅ Enable download button after successful compilation
                        downloadPdfBtn.setAttribute("data-pdf-url", data.pdfUrl);
                        downloadPdfBtn.disabled = false;
                    } else {
                        compilationStatus.textContent = "Compilation failed!";
                        console.error("Compilation error:", data.error);
                        alert("Error compiling LaTeX: " + data.error);
                    }
                    fetchErrors(); // ✅ Fetch and display errors
                })
                .catch(error => {
                    compilationStatus.textContent = "Compilation failed!";
                    console.error("Network or server error:", error);
                    alert("Error: Could not reach the server. Check your internet connection.");
                    fetchErrors(); // ✅ Fetch and display errors
                });
            });

            // ✅ Download PDF when the "Download PDF" button is clicked
            downloadPdfBtn.addEventListener('click', function() {
                let pdfUrl = downloadPdfBtn.getAttribute("data-pdf-url");

                if (!pdfUrl) {
                    alert("No PDF available. Please compile the document first.");
                    return;
                }

                console.log("[INFO] Downloading PDF: " + pdfUrl);
                let link = document.createElement("a");
                link.href = pdfUrl;
                link.download = "Compiled_Document.pdf";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // ✅ Load errors on page load
            fetchErrors();
        });
    </script>
}

